name: Build & Deploy

on:
  push:
    branches: ["main"]

env:
  IMAGE_NAME: ghcr.io/${{ github.repository }}
  CHART_PATH: charts/fastapi
  RELEASE_NAME: fastapi
  KUBE_NAMESPACE: fastapi

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push image
        env:
          IMAGE_TAG: ${{ github.sha }}
        run: |
          docker build -t ${IMAGE_NAME}:${IMAGE_TAG} -t ${IMAGE_NAME}:latest .
          docker push ${IMAGE_NAME}:${IMAGE_TAG}
          docker push ${IMAGE_NAME}:latest

  deploy:
    runs-on: ubuntu-latest
    needs: build
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.15.2

      - name: Configure kubeconfig
        env:
          KUBECONFIG_B64: ${{ secrets.K3S_KUBECONFIG_B64 }}
        run: |
          if [ -z "$KUBECONFIG_B64" ]; then
            echo "K3S_KUBECONFIG_B64 secret is not set" >&2
            exit 1
          fi
          echo "$KUBECONFIG_B64" | base64 -d > kubeconfig

      - name: Deploy with Helm
        env:
          IMAGE_TAG: ${{ github.sha }}
        run: |
          export KUBECONFIG=$PWD/kubeconfig
          helm upgrade --install ${RELEASE_NAME} ${CHART_PATH} \
            --namespace ${KUBE_NAMESPACE} \
            --create-namespace \
            --set image.repository=${IMAGE_NAME} \
            --set image.tag=${IMAGE_TAG}
